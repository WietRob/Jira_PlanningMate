name: Forge CI/CD

on:
  push:
    branches: [main, master]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.json'
      - '**.yml'
      - '**.yaml'
      - 'manifest.yml'
      - 'jira-plugin/manifest.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  FORGE_ENVIRONMENT: development
  FORGE_ANALYTICS_OPT_IN: 'false'
  CI: 'true'

jobs:
  build:
    name: Build App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd jira-plugin && npm ci && cd ..

      - name: Build functions
        run: npm run build:functions
        working-directory: ./jira-plugin

      - name: Build UI
        run: npm run build:ui
        working-directory: ./jira-plugin

      - name: Verify build output
        run: |
          ls -la jira-plugin/dist/
          ls -la jira-plugin/static/
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd jira-plugin && npm ci && cd ..

      - name: Build functions
        run: npm run build:functions
        working-directory: ./jira-plugin

      - name: Build UI
        run: npm run build:ui
        working-directory: ./jira-plugin

      - name: Verify build output
        run: |
          ls -la jira-plugin/dist/
          ls -la jira-plugin/static/

  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Forge CLI
        run: |
          npm install -g @forge/cli
          mkdir -p ~/.config/forge
          echo '{"analytics": false}' > ~/.config/forge/config.json

      - name: Deploy to Forge
        run: forge deploy --environment=${{ env.FORGE_ENVIRONMENT }}
        env:
          FORGE_EMAIL: ${{ secrets.FORGE_EMAIL }}
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}

      - name: Upgrade Installation
        run: forge install --upgrade all --environment=${{ env.FORGE_ENVIRONMENT }}
        env:
          FORGE_EMAIL: ${{ secrets.FORGE_EMAIL }}
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}

  test:
    name: Playwright Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Restore Playwright Auth
        run: |
          mkdir -p playwright/.auth
          echo "$PLAYWRIGHT_STATE" | base64 -d > playwright/.auth/state.json
        env:
          PLAYWRIGHT_STATE: ${{ secrets.PLAYWRIGHT_STATE }}

      - name: Run Playwright Tests
        run: npx playwright test --project=chromium
        continue-on-error: false

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload Playwright Traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7

  logs:
    name: Check Forge Logs
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Forge CLI
        run: |
          npm install -g @forge/cli
          mkdir -p ~/.config/forge
          echo '{"analytics": false}' > ~/.config/forge/config.json

      - name: Check Recent Logs
        run: |
          echo "=== Forge Logs ==="
          echo "n" | forge logs --tail --limit=50
        env:
          FORGE_EMAIL: ${{ secrets.FORGE_EMAIL }}
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}
        continue-on-error: true

      - name: Check for Errors
        run: |
          ERROR_COUNT=$(echo "n" | forge logs --tail --limit=100 --json 2>/dev/null | grep -c "error" || echo "0")
          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "⚠️ Found $ERROR_COUNT potential errors in logs"
            echo "n" | forge logs --tail --limit=100
            exit 1
          else
            echo "✅ No errors found in Forge logs"
          fi
        env:
          FORGE_EMAIL: ${{ secrets.FORGE_EMAIL }}
          FORGE_API_TOKEN: ${{ secrets.FORGE_API_TOKEN }}

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()
    needs: [build, deploy, test, logs]
    steps:
      - name: Summary
        run: |
          echo "=== Forge CI/CD Pipeline Complete ==="
          echo "Status: ${{ job.status }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
